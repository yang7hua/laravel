<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>Laravel Cashier - Laravel 5.1 中文文档 | Laravel 中文网</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Laravel 中文网">
    <meta name="description" content="Laravel - 为 WEB 艺术家创造的 PHP 框架。| Laravel 中文网">
    <meta name="keywords" content="Laravel中文社区,php框架,laravel中文网,php framework,restful routing,laravel,laravel php">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lte IE 9]>
		<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../assets/css/laravel.css">
    <link rel="stylesheet" href="../../assets/css/patch.css">
</head>

<body class="docs language-php">

    <span class="overlay"></span>

    <nav class="main">
        <div class="container">
            <a href="http://www.golaravel.com/laravel/" class="brand">
                <img src="../../assets/img/laravel-logo.png" height="30"> Laravel
            </a>

            <div class="responsive-sidebar-nav">
                <a href="billing#" class="toggle-slide menu-link btn">&#9776;</a>
            </div>

            <div class="switcher">
                <div class="dropdown">
                    <button class="btn dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
                        <!--<span class="faint">v</span> -->
                        5.1
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation">
                            <a role="menuitem" tabindex="-1" href="index.html">5.1</a>
                        </li>
                        <li role="presentation">
                            <a role="menuitem" tabindex="-1" href="http://www.golaravel.com/laravel/docs/5.0">5.0</a>
                        </li>
                        <li role="presentation">
                            <a role="menuitem" tabindex="-1" href="http://www.golaravel.com/laravel/docs/4.2">4.2</a>
                        </li>
                        <li role="presentation">
                            <a role="menuitem" tabindex="-1" href="http://www.golaravel.com/laravel/docs/4.1">4.1</a>
                        </li>
                        <li role="presentation">
                            <a role="menuitem" tabindex="-1" href="http://www.golaravel.com/laravel/docs/4.0">4.0</a>
                        </li>
                    </ul>
                </div>
            </div>

            <ul class="main-nav">
                <li class="nav-docs"><a href="http://www.golaravel.com/laravel/docs/">中文文档</a>
                </li>
                <li class="nav-community"><a href="http://wenda.golaravel.com" target="_blank">问答社区</a>
                </li>
                <li class="nav-api"><a href="http://laravel.com/api/5.0/" target="_blank">API</a>
                </li>
                <li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">视频教程（国外）</a>
                </li>
                <li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a>
                </li>

            </ul>
        </div>
    </nav>

    <nav id="slide-menu" class="slide-menu" role="navigation">

        <div class="brand">
            <a href="http://www.golaravel.com/laravel/">
                <img src="../../assets/img/laravel-logo-white.png" height="50">
            </a>
        </div>

        <ul class="slide-main-nav">
            <li><a href="http://www.golaravel.com/laravel/">首页</a>
            </li>
            <li class="nav-docs"><a href="http://www.golaravel.com/laravel/docs/">中文文档</a>
            </li>
            <li class="nav-community"><a href="http://wenda.golaravel.com" target="_blank">问答社区</a>
            </li>
            <li class="nav-api"><a href="http://laravel.com/api/5.0/" target="_blank">API</a>
            </li>
            <li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">视频教程（国外）</a>
            </li>
            <li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a>
            </li>

        </ul>

        <div class="slide-docs-nav">
            <h2>文档目录</h2>
            <ul>
                <li>序言
                    <ul>
                        <li><a href="releases">版本说明</a>
                        </li>
                        <li><a href="upgrade">升级指南</a>
                        </li>
                        <li><a href="contributions">贡献指南</a>
                        </li>
                        <li><a href="http://www.golaravel.com/laravel/api/5.1">API 文档</a>
                        </li>
                    </ul>
                </li>
                <li>安装设置
                    <ul>
                        <li><a href="installation">安装</a>
                        </li>
                        <li><a href="homestead">Homestead</a>
                        </li>
                    </ul>
                </li>
                <li>教程
                    <ul>
                        <li><a href="quickstart">入门学习任务</a>
                        </li>
                        <li><a href="quickstart-intermediate">中级学习任务</a>
                        </li>
                    </ul>
                </li>
                <li>基础知识
                    <ul>
                        <li><a href="routing">路由</a>
                        </li>
                        <li><a href="middleware">中间件</a>
                        </li>
                        <li><a href="controllers">控制器</a>
                        </li>
                        <li><a href="requests">请求</a>
                        </li>
                        <li><a href="responses">响应</a>
                        </li>
                        <li><a href="views">视图</a>
                        </li>
                        <li><a href="blade">Blade 模板</a>
                        </li>
                    </ul>
                </li>
                <li>系统架构
                    <ul>
                        <li><a href="lifecycle">请求的生命周期</a>
                        </li>
                        <li><a href="structure">应用程序结构</a>
                        </li>
                        <li><a href="providers">服务提供者</a>
                        </li>
                        <li><a href="container">服务容器</a>
                        </li>
                        <li><a href="contracts">Contract</a>
                        </li>
                        <li><a href="facades">Facade</a>
                        </li>
                    </ul>
                </li>
                <li>系统服务
                    <ul>
                        <li><a href="authentication">认证</a>
                        </li>
                        <li><a href="authorization">授权</a>
                        </li>
                        <li><a href="artisan">Artisan 控制台</a>
                        </li>
                        <li><a href="billing">计费</a>
                        </li>
                        <li><a href="cache">缓存</a>
                        </li>
                        <li><a href="collections">集合</a>
                        </li>
                        <li><a href="elixir">Elixir</a>
                        </li>
                        <li><a href="encryption">加密</a>
                        </li>
                        <li><a href="errors">错误与日志</a>
                        </li>
                        <li><a href="events">事件</a>
                        </li>
                        <li><a href="filesystem">文件系统 / 云存储</a>
                        </li>
                        <li><a href="hashing">哈希</a>
                        </li>
                        <li><a href="helpers">辅助方法</a>
                        </li>
                        <li><a href="localization">本地化</a>
                        </li>
                        <li><a href="mail">邮件</a>
                        </li>
                        <li><a href="packages">扩展包开发</a>
                        </li>
                        <li><a href="pagination">分页</a>
                        </li>
                        <li><a href="queues">队列</a>
                        </li>
                        <li><a href="redis">Redis</a>
                        </li>
                        <li><a href="session">会话</a>
                        </li>
                        <li><a href="envoy">SSH 任务</a>
                        </li>
                        <li><a href="scheduling">任务调度</a>
                        </li>
                        <li><a href="testing">测试</a>
                        </li>
                        <li><a href="validation">验证</a>
                        </li>
                    </ul>
                </li>
                <li>数据库
                    <ul>
                        <li><a href="database">入门</a>
                        </li>
                        <li><a href="queries">查询构造器</a>
                        </li>
                        <li><a href="migrations">迁移</a>
                        </li>
                        <li><a href="seeding">数据填充</a>
                        </li>
                    </ul>
                </li>
                <li>Eloquent ORM
                    <ul>
                        <li><a href="eloquent">入门</a>
                        </li>
                        <li><a href="eloquent-relationships">关系</a>
                        </li>
                        <li><a href="eloquent-collections">集合</a>
                        </li>
                        <li><a href="eloquent-mutators">调整修改</a>
                        </li>
                        <li><a href="eloquent-serialization">序列化</a>
                        </li>
                    </ul>
                </li>
            </ul>

        </div>

    </nav>

    <div class="docs-wrapper container">

        <section class="sidebar">
            <ul>
                <li>序言
                    <ul>
                        <li><a href="releases">版本说明</a>
                        </li>
                        <li><a href="upgrade">升级指南</a>
                        </li>
                        <li><a href="contributions">贡献指南</a>
                        </li>
                        <li><a href="http://www.golaravel.com/laravel/api/5.1">API 文档</a>
                        </li>
                    </ul>
                </li>
                <li>安装设置
                    <ul>
                        <li><a href="installation">安装</a>
                        </li>
                        <li><a href="homestead">Homestead</a>
                        </li>
                    </ul>
                </li>
                <li>教程
                    <ul>
                        <li><a href="quickstart">入门学习任务</a>
                        </li>
                        <li><a href="quickstart-intermediate">中级学习任务</a>
                        </li>
                    </ul>
                </li>
                <li>基础知识
                    <ul>
                        <li><a href="routing">路由</a>
                        </li>
                        <li><a href="middleware">中间件</a>
                        </li>
                        <li><a href="controllers">控制器</a>
                        </li>
                        <li><a href="requests">请求</a>
                        </li>
                        <li><a href="responses">响应</a>
                        </li>
                        <li><a href="views">视图</a>
                        </li>
                        <li><a href="blade">Blade 模板</a>
                        </li>
                    </ul>
                </li>
                <li>系统架构
                    <ul>
                        <li><a href="lifecycle">请求的生命周期</a>
                        </li>
                        <li><a href="structure">应用程序结构</a>
                        </li>
                        <li><a href="providers">服务提供者</a>
                        </li>
                        <li><a href="container">服务容器</a>
                        </li>
                        <li><a href="contracts">Contract</a>
                        </li>
                        <li><a href="facades">Facade</a>
                        </li>
                    </ul>
                </li>
                <li>系统服务
                    <ul>
                        <li><a href="authentication">认证</a>
                        </li>
                        <li><a href="authorization">授权</a>
                        </li>
                        <li><a href="artisan">Artisan 控制台</a>
                        </li>
                        <li><a href="billing">计费</a>
                        </li>
                        <li><a href="cache">缓存</a>
                        </li>
                        <li><a href="collections">集合</a>
                        </li>
                        <li><a href="elixir">Elixir</a>
                        </li>
                        <li><a href="encryption">加密</a>
                        </li>
                        <li><a href="errors">错误与日志</a>
                        </li>
                        <li><a href="events">事件</a>
                        </li>
                        <li><a href="filesystem">文件系统 / 云存储</a>
                        </li>
                        <li><a href="hashing">哈希</a>
                        </li>
                        <li><a href="helpers">辅助方法</a>
                        </li>
                        <li><a href="localization">本地化</a>
                        </li>
                        <li><a href="mail">邮件</a>
                        </li>
                        <li><a href="packages">扩展包开发</a>
                        </li>
                        <li><a href="pagination">分页</a>
                        </li>
                        <li><a href="queues">队列</a>
                        </li>
                        <li><a href="redis">Redis</a>
                        </li>
                        <li><a href="session">会话</a>
                        </li>
                        <li><a href="envoy">SSH 任务</a>
                        </li>
                        <li><a href="scheduling">任务调度</a>
                        </li>
                        <li><a href="testing">测试</a>
                        </li>
                        <li><a href="validation">验证</a>
                        </li>
                    </ul>
                </li>
                <li>数据库
                    <ul>
                        <li><a href="database">入门</a>
                        </li>
                        <li><a href="queries">查询构造器</a>
                        </li>
                        <li><a href="migrations">迁移</a>
                        </li>
                        <li><a href="seeding">数据填充</a>
                        </li>
                    </ul>
                </li>
                <li>Eloquent ORM
                    <ul>
                        <li><a href="eloquent">入门</a>
                        </li>
                        <li><a href="eloquent-relationships">关系</a>
                        </li>
                        <li><a href="eloquent-collections">集合</a>
                        </li>
                        <li><a href="eloquent-mutators">调整修改</a>
                        </li>
                        <li><a href="eloquent-serialization">序列化</a>
                        </li>
                    </ul>
                </li>
            </ul>

        </section>

        <article>
            <h1>Laravel Cashier</h1>
            <ul>
                <li><a href="billing#introduction">Introduction</a>
                </li>
                <li><a href="billing#subscriptions">Subscriptions</a>
                    <ul>
                        <li><a href="billing#creating-subscriptions">Creating Subscriptions</a>
                        </li>
                        <li><a href="billing#checking-subscription-status">Checking Subscription Status</a>
                        </li>
                        <li><a href="billing#changing-plans">Changing Plans</a>
                        </li>
                        <li><a href="billing#subscription-quantity">Subscription Quantity</a>
                        </li>
                        <li><a href="billing#subscription-taxes">Subscription Taxes</a>
                        </li>
                        <li><a href="billing#cancelling-subscriptions">Cancelling Subscriptions</a>
                        </li>
                        <li><a href="billing#resuming-subscriptions">Resuming Subscriptions</a>
                        </li>
                    </ul>
                </li>
                <li><a href="billing#handling-stripe-webhooks">Handling Stripe Webhooks</a>
                    <ul>
                        <li><a href="billing#handling-failed-subscriptions">Failed Subscriptions</a>
                        </li>
                        <li><a href="billing#handling-other-webhooks">Other Webhooks</a>
                        </li>
                    </ul>
                </li>
                <li><a href="billing#single-charges">Single Charges</a>
                </li>
                <li><a href="billing#invoices">Invoices</a>
                    <ul>
                        <li><a href="billing#generating-invoice-pdfs">Generating Invoice PDFs</a>
                        </li>
                    </ul>
                </li>
            </ul>
            <p>
                <a name="introduction"></a>
            </p>
            <h2>Introduction</h2>
            <p>Laravel Cashier provides an expressive, fluent interface to <a href="https://stripe.com" target="_blank">Stripe's</a> subscription billing services. It handles almost all of the boilerplate subscription billing code you are dreading writing. In addition to
                basic subscription management, Cashier can handle coupons, swapping subscription, subscription &quot;quantities&quot;, cancellation grace periods, and even generate invoice PDFs.</p>
            <p>
                <a name="configuration"></a>
            </p>
            <h3>Configuration</h3>
            <h4>Composer</h4>
            <p>First, add the Cashier package to your <code>composer.json</code> file and run the <code>composer update</code> command:</p>
            <pre><code>&quot;laravel/cashier&quot;: &quot;~5.0&quot; (For Stripe SDK ~2.0, and Stripe APIs on 2015-02-18 version and later)
&quot;laravel/cashier&quot;: &quot;~4.0&quot; (For Stripe APIs on 2015-02-18 version and later)
&quot;laravel/cashier&quot;: &quot;~3.0&quot; (For Stripe APIs up to and including 2015-02-16 version)
</code></pre>
            <h4>Service Provider</h4>
            <p>Next, register the <code>Laravel\Cashier\CashierServiceProvider</code> <a href="providers">service provider</a> in your <code>app</code> configuration file.</p>
            <h4>Migration</h4>
            <p>Before using Cashier, we'll need to add several columns to your database. Don't worry, you can use the <code>cashier:table</code> Artisan command to create a migration to add the necessary column. For example, to add the column to the users
                table run the command: <code>php artisan cashier:table users</code>.</p>
            <p>Once the migration has been created, simply run the <code>migrate</code> command.</p>
            <h4>Model Setup</h4>
            <p>Next, add the <code>Billable</code> trait and appropriate date mutators to your model definition:</p>
            <pre><code>use Laravel\Cashier\Billable;
use Laravel\Cashier\Contracts\Billable as BillableContract;

class User extends Model implements BillableContract
{
    use Billable;

    protected $dates = ['trial_ends_at', 'subscription_ends_at'];
}
</code></pre>
            <p>Adding the columns to your model's <code>$dates</code> property will instruct Eloquent to return the columns as Carbon / DateTime instances instead of raw strings.</p>
            <h4>Stripe Key</h4>
            <p>Finally, set your Stripe key in your <code>services.php</code> configuration file:</p>
            <pre><code>'stripe' =&gt; [
    'model'  =&gt; 'User',
    'secret' =&gt; env('STRIPE_API_SECRET'),
],
</code></pre>
            <p>
                <a name="subscriptions"></a>
            </p>
            <h2>Subscriptions</h2>
            <p>
                <a name="creating-subscriptions"></a>
            </p>
            <h3>Creating Subscriptions</h3>
            <p>To create a subscription, first retrieve an instance of your billable model, which typically will be an instance of <code>App\User</code>. Once you have retrieved the model instance, you may use the <code>subscription</code> method to manage
                the model's subscription:</p>
            <pre><code>$user = User::find(1);

$user-&gt;subscription('monthly')-&gt;create($creditCardToken);
</code></pre>
            <p>The <code>create</code> method will automatically create the Stripe subscription, as well as update your database with Stripe customer ID and other relevant billing information. If your plan has a trial configured in Stripe, the trial end
                date will also automatically be set on the user record.</p>
            <p>If you want to implement trial periods, but are managing the trials entirely within your application instead of defining them within Stripe, you must manually set the trial end date:</p>
            <pre><code>$user-&gt;trial_ends_at = Carbon::now()-&gt;addDays(14);

$user-&gt;save();
</code></pre>
            <h4>Additional User Details</h4>
            <p>If you would like to specify additional customer details, you may do so by passing them as the second argument to the <code>create</code> method:</p>
            <pre><code>$user-&gt;subscription('monthly')-&gt;create($creditCardToken, [
    'email' =&gt; $email, 'description' =&gt; 'Our First Customer'
]);
</code></pre>
            <p>To learn more about the additional fields supported by Stripe, check out Stripe's <a href="https://stripe.com/docs/api#create_customer" target="_blank">documentation on customer creation</a>.</p>
            <h4>Coupons</h4>
            <p>If you would like to apply a coupon when creating the subscription, you may use the <code>withCoupon</code> method:</p>
            <pre><code>$user-&gt;subscription('monthly')
     -&gt;withCoupon('code')
     -&gt;create($creditCardToken);
</code></pre>
            <p>
                <a name="checking-subscription-status"></a>
            </p>
            <h3>Checking Subscription Status</h3>
            <p>Once a user is subscribed to your application, you may easily check their subscription status using a variety of convenient methods. First, the <code>subscribed</code> method returns <code>true</code> if the user has an active subscription,
                even if the subscription is currently within its trial period:</p>
            <pre><code>if ($user-&gt;subscribed()) {
    //
}
</code></pre>
            <p>The <code>subscribed</code> method also makes a great candidate for a <a href="middleware">route middleware</a>, allowing you to filter access to routes and controllers based on the user's subscription status:</p>
            <pre><code>public function handle($request, Closure $next)
{
    if ($request-&gt;user() &amp;&amp; ! $request-&gt;user()-&gt;subscribed()) {
        // This user is not a paying customer...
        return redirect('billing');
    }

    return $next($request);
}
</code></pre>
            <p>If you would like to determine if a user is still within their trial period, you may use the <code>onTrial</code> method. This method can be useful for displaying a warning to the user that they are still on their trial period:</p>
            <pre><code>if ($user-&gt;onTrial()) {
    //
}
</code></pre>
            <p>The <code>onPlan</code> method may be used to determine if the user is subscribed to a given plan based on its Stripe ID:</p>
            <pre><code>if ($user-&gt;onPlan('monthly')) {
    //
}
</code></pre>
            <h4>Cancelled Subscription Status</h4>
            <p>To determine if the user was once an active subscriber, but has cancelled their subscription, you may use the <code>cancelled</code> method:</p>
            <pre><code>if ($user-&gt;cancelled()) {
    //
}
</code></pre>
            <p>You may also determine if a user has cancelled their subscription, but are still on their &quot;grace period&quot; until the subscription fully expires. For example, if a user cancels a subscription on March 5th that was originally scheduled
                to expire on March 10th, the user is on their &quot;grace period&quot; until March 10th. Note that the <code>subscribed</code> method still returns <code>true</code> during this time.</p>
            <pre><code>if ($user-&gt;onGracePeriod()) {
    //
}
</code></pre>
            <p>The <code>everSubscribed</code> method may be used to determine if the user has ever subscribed to a plan in your application:</p>
            <pre><code>if ($user-&gt;everSubscribed()) {
    //
}
</code></pre>
            <p>
                <a name="changing-plans"></a>
            </p>
            <h3>Changing Plans</h3>
            <p>After a user is subscribed to your application, they may occasionally want to change to a new subscription plan. To swap a user to a new subscription, use the <code>swap</code> method. For example, we may easily switch a user to the <code>premium</code>                subscription:</p>
            <pre><code>$user = App\User::find(1);

$user-&gt;subscription('premium')-&gt;swap();
</code></pre>
            <p>If the user is on trial, the trial period will be maintained. Also, if a &quot;quantity&quot; exists for the subscription, that quantity will also be maintained. When swapping plans, you may also use the <code>prorate</code> method to indicate
                that the charges should be pro-rated. In addition, you may use the <code>swapAndInvoice</code> method to immediately invoice the user for the plan change:</p>
            <pre><code>$user-&gt;subscription('premium')
            -&gt;prorate()
            -&gt;swapAndInvoice();
</code></pre>
            <p>
                <a name="subscription-quantity"></a>
            </p>
            <h3>Subscription Quantity</h3>
            <p>Sometimes subscriptions are affected by &quot;quantity&quot;. For example, your application might charge $10 per month <strong>per user</strong> on an account. To easily increment or decrement your subscription quantity, use the <code>increment</code>                and <code>decrement</code> methods:</p>
            <pre><code>$user = User::find(1);

$user-&gt;subscription()-&gt;increment();

// Add five to the subscription's current quantity...
$user-&gt;subscription()-&gt;increment(5);

$user-&gt;subscription()-&gt;decrement();

// Subtract five to the subscription's current quantity...
$user-&gt;subscription()-&gt;decrement(5);
</code></pre>
            <p>Alternatively, you may set a specific quantity using the <code>updateQuantity</code> method:</p>
            <pre><code>$user-&gt;subscription()-&gt;updateQuantity(10);
</code></pre>
            <p>For more information on subscription quantities, consult the <a href="https://stripe.com/docs/guides/subscriptions#setting-quantities" target="_blank">Stripe documentation</a>.</p>
            <p>
                <a name="subscription-taxes"></a>
            </p>
            <h3>Subscription Taxes</h3>
            <p>With Cashier, it's easy to provide the <code>tax_percent</code> value sent to Stripe. To specify the tax percentage a user pays on a subscription, implement the <code>getTaxPercent</code> method on your billable model, and return a numeric
                value between 0 and 100, with no more than 2 decimal places.</p>
            <pre><code>public function getTaxPercent() {
    return 20;
}
</code></pre>
            <p>This enables you to apply a tax rate on a model-by-model basis, which may be helpful for a user base that spans multiple countries.</p>
            <p>
                <a name="cancelling-subscriptions"></a>
            </p>
            <h3>Cancelling Subscriptions</h3>
            <p>To cancel a subscription, simply call the <code>cancel</code> method on the user's subscription:</p>
            <pre><code>$user-&gt;subscription()-&gt;cancel();
</code></pre>
            <p>When a subscription is cancelled, Cashier will automatically set the <code>subscription_ends_at</code> column in your database. This column is used to know when the <code>subscribed</code> method should begin returning <code>false</code>.
                For example, if a customer cancels a subscription on March 1st, but the subscription was not scheduled to end until March 5th, the <code>subscribed</code> method will continue to return <code>true</code> until March 5th.</p>
            <p>You may determine if a user has cancelled their subscription but are still on their &quot;grace period&quot; using the <code>onGracePeriod</code> method:</p>
            <pre><code>if ($user-&gt;onGracePeriod()) {
    //
}
</code></pre>
            <p>
                <a name="resuming-subscriptions"></a>
            </p>
            <h3>Resuming Subscriptions</h3>
            <p>If a user has cancelled their subscription and you wish to resume it, use the <code>resume</code> method:</p>
            <pre><code>$user-&gt;subscription('monthly')-&gt;resume($creditCardToken);
</code></pre>
            <p>If the user cancels a subscription and then resumes that subscription before the subscription has fully expired, they will not be billed immediately. Instead, their subscription will simply be re-activated, and they will be billed on the original
                billing cycle.</p>
            <p>
                <a name="handling-stripe-webhooks"></a>
            </p>
            <h2>Handling Stripe Webhooks</h2>
            <p>
                <a name="handling-failed-subscriptions"></a>
            </p>
            <h3>Failed Subscriptions</h3>
            <p>What if a customer's credit card expires? No worries - Cashier includes a Webhook controller that can easily cancel the customer's subscription for you. Just point a route to the controller:</p>
            <pre><code>Route::post('stripe/webhook', '\Laravel\Cashier\WebhookController@handleWebhook');
</code></pre>
            <p>That's it! Failed payments will be captured and handled by the controller. The controller will cancel the customer's subscription when Stripe determines the subscription has failed (normally after three failed payment attempts). Don't forget:
                you will need to configure the webhook URI in your Stripe control panel settings.</p>
            <p>Since Stripe webhooks need to bypass Laravel's <a href="routing#csrf-protection">CSRF verification</a>, be sure to list the URI as an exception in your <code>VerifyCsrfToken</code> middleware:</p>
            <pre><code>protected $except = [
    'stripe/*',
];
</code></pre>
            <p>
                <a name="handling-other-webhooks"></a>
            </p>
            <h3>Other Webhooks</h3>
            <p>If you have additional Stripe webhook events you would like to handle, simply extend the Webhook controller. Your method names should correspond to Cashier's expected convention, specifically, methods should be prefixed with <code>handle</code>                and the &quot;camel case&quot; name of the Stripe webhook you wish to handle. For example, if you wish to handle the <code>invoice.payment_succeeded</code> webhook, you should add a <code>handleInvoicePaymentSucceeded</code> method to
                the controller.</p>
            <pre><code>&lt;?php

namespace App\Http\Controllers;

use Laravel\Cashier\WebhookController as BaseController;

class WebhookController extends BaseController
{
    /**
     * Handle a stripe webhook.
     *
     * @param  array  $payload
     * @return Response
     */
    public function handleInvoicePaymentSucceeded($payload)
    {
        // Handle The Event
    }
}
</code></pre>
            <p>
                <a name="single-charges"></a>
            </p>
            <h2>Single Charges</h2>
            <p>If you would like to make a &quot;one off&quot; charge against a subscribed customer's credit card, you may use the <code>charge</code> method on a billable model instance. The <code>charge</code> method accepts the amount you would like to
                charge in the <strong>lowest denominator of the currency used by your application</strong>. So, for example, the example below will charge 100 cents, or $1.00, against the user's credit card:</p>
            <pre><code>$user-&gt;charge(100);
</code></pre>
            <p>The <code>charge</code> method accepts an array as its second argument, allowing you to pass any options you wish to the underlying Stripe charge creation:</p>
            <pre><code>$user-&gt;charge(100, [
    'source' =&gt; $token,
    'receipt_email' =&gt; $user-&gt;email,
]);
</code></pre>
            <p>The <code>charge</code> method will return <code>false</code> if the charge fails. This typically indicates the charge was denied:</p>
            <pre><code>if ( ! $user-&gt;charge(100)) {
    // The charge was denied...
}
</code></pre>
            <p>If the charge is successful, the full Stripe response will be returned from the method.</p>
            <p>
                <a name="invoices"></a>
            </p>
            <h2>Invoices</h2>
            <p>You may easily retrieve an array of a billable model's invoices using the <code>invoices</code> method:</p>
            <pre><code>$invoices = $user-&gt;invoices();
</code></pre>
            <p>When listing the invoices for the customer, you may use the invoice's helper methods to display the relevant invoice information. For example, you may wish to list every invoice in a table, allowing the user to easily download any of them:</p>
            <pre><code>&lt;table&gt;
    @foreach ($invoices as $invoice)
        &lt;tr&gt;
            &lt;td&gt;{{ $invoice-&gt;dateString() }}&lt;/td&gt;
            &lt;td&gt;{{ $invoice-&gt;dollars() }}&lt;/td&gt;
            &lt;td&gt;&lt;a href=&quot;/user/invoice/{{ $invoice-&gt;id }}&quot;&gt;Download&lt;/a&gt;&lt;/td&gt;
        &lt;/tr&gt;
    @endforeach
&lt;/table&gt;
</code></pre>
            <p>
                <a name="generating-invoice-pdfs"></a>
            </p>
            <h4>Generating Invoice PDFs</h4>
            <p>From within a route or controller, use the <code>downloadInvoice</code> method to generate a PDF download of the invoice. This method will automatically generate the proper HTTP response to send the download to the browser:</p>
            <pre><code>Route::get('user/invoice/{invoice}', function ($invoiceId) {
    return Auth::user()-&gt;downloadInvoice($invoiceId, [
        'vendor'  =&gt; 'Your Company',
        'product' =&gt; 'Your Product',
    ]);
});
</code></pre>

        </article>
    </div>


    <footer class="main">
        <ul>
            <li class="nav-docs"><a href="http://www.golaravel.com/laravel/docs/">中文文档</a>
            </li>
            <li class="nav-community"><a href="http://wenda.golaravel.com" target="_blank">问答社区</a>
            </li>
            <li class="nav-api"><a href="http://laravel.com/api/5.0/" target="_blank">API</a>
            </li>
            <li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">视频教程（国外）</a>
            </li>
            <li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a>
            </li>

        </ul>
        <p>Laravel is a trademark of Taylor Otwell. Copyright &copy; Taylor Otwell.</p>
        <p class="less-significant"><a href="http://jackmcdade.com" target="_blank">Design by Jack McDade</a>
        </p>
    </footer>

    <script src="../../assets/js/laravel.js"></script>
    <script src="../../assets/js/viewport-units-buggyfill.js"></script>
    <script>
        window.viewportUnitsBuggyfill.init();
    </script>
    <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fc8d13872a523d9c286aa7affbe0921f1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</body>

</html>